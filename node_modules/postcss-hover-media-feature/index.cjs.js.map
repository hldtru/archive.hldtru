{"version":3,"file":"index.cjs.js","sources":["index.js"],"sourcesContent":["const selectorParser = require('postcss-selector-parser')\n\nconst selectorProcessor = selectorParser(selectors => {\n  let hoverSelectors = []\n\n  selectors.walk(selector => {\n    if (selector.type === 'pseudo' && `${selector}` === ':hover') {\n      hoverSelectors.push(`${selector.parent}`)\n    }\n  })\n\n  let nonHoverSelectors = selectors.reduce((acc, selector) => {\n    if (hoverSelectors.includes(`${selector}`)) {\n      return acc\n    }\n\n    return [...acc, `${selector}`]\n  }, [])\n\n  return { hoverSelectors, nonHoverSelectors }\n})\n\nmodule.exports = ({\n  fallback = false,\n  fallbackSelector = 'html:not(.supports-touch)',\n  rootSelectors = []\n} = {}) => {\n  function createMediaQuery (rule, { AtRule }) {\n    let media = new AtRule({ name: 'media', params: '(hover: hover)' })\n\n    media.source = rule.source\n\n    media.append(rule)\n\n    return media\n  }\n\n  function isAlreadyNested (rule) {\n    let container = rule.parent\n\n    while (container !== null && container.type !== 'root') {\n      if (\n        container.type === 'atrule' &&\n        container.params.includes('hover: hover')\n      ) {\n        return true\n      }\n\n      container = container.parent\n    }\n\n    return false\n  }\n\n  return {\n    postcssPlugin: 'postcss-hover-media-feature',\n\n    Rule (rule, { AtRule }) {\n      if (\n        !rule.selector.includes(':hover') ||\n        isAlreadyNested(rule) ||\n        rule.selector.includes(fallbackSelector)\n      ) {\n        return\n      }\n\n      let {\n        hoverSelectors = [],\n        nonHoverSelectors = []\n      } = selectorProcessor.transformSync(rule.selector, { lossless: false })\n\n      let mediaQuery = createMediaQuery(\n        rule.clone({ selectors: hoverSelectors }),\n        { AtRule }\n      )\n\n      rule.after(mediaQuery)\n\n      if (fallback) {\n        rule.before(\n          rule.clone({\n            selectors: hoverSelectors.map(hoverSelector => {\n              if (\n                rootSelectors.some(rootSelector =>\n                  hoverSelector.startsWith(rootSelector)\n                )\n              ) {\n                return `${fallbackSelector}${hoverSelector}`\n              }\n              return `${fallbackSelector} ${hoverSelector}`\n            })\n          })\n        )\n      }\n\n      if (nonHoverSelectors.length) {\n        rule.replaceWith(rule.clone({ selectors: nonHoverSelectors }))\n\n        return\n      }\n\n      rule.remove()\n    }\n  }\n}\n\nmodule.exports.postcss = true\n"],"names":["selectorParser","require","selectorProcessor","selectors","hoverSelectors","walk","selector","type","push","parent","nonHoverSelectors","reduce","acc","includes","module","exports","fallback","fallbackSelector","rootSelectors","createMediaQuery","rule","AtRule","media","name","params","source","append","isAlreadyNested","container","postcssPlugin","Rule","transformSync","lossless","mediaQuery","clone","after","before","map","hoverSelector","some","rootSelector","startsWith","length","replaceWith","remove","postcss"],"mappings":"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"}